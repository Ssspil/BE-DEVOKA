name: CI/CD with Gradle

on:
  push:
    branches: [ "dev", "main"] 


jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      -    name: Checkout
           uses: actions/checkout@v4
        
      -    name: Set up JDK 17
           uses: actions/setup-java@v4
           with:
             java-version: '17'
             distribution: 'temurin'
  
      -    name: Run Test with Gradle
           run: ./gradlew test
          
  deploy:
    if: github.ref == 'refs/heads/main' # main 브런치 일 때만 실행
    runs-on: self-hosted
    timeout-minutes: 5
    steps:
      -    name: Checkout
           uses: actions/checkout@v4

      -    name: Print working directory
           run: |
              echo "현재 작업 디렉토리:"
              pwd

      -    name: Set up JDK 17
           uses: actions/setup-java@v4
           with:
             java-version: '17'
             distribution: 'temurin'
             
      -    name: Change Directory
           run: | 
             cd ~
               echo "변경 후 현재 작업 디렉토리:"
               pwd
           
      -    name: Grant execute permission for deploy.sh
           run: chmod +x ./deploy.sh
           
      -    name: Run deploy script
           run: ./deploy.sh

           

      # -    name: Stop Existing Application (if running)
      #      run: |
      #        pkill -f '/home/ubuntu/project/devoka-0.0.1-SNAPSHOT.jar' || true
      #        echo '서버죽이기 완료'
            
      # -    name: Grant execute permission for gradlew
      #      run: chmod +x gradlew

      # -    name: Build with Gradle
      #      run: ./gradlew build --no-daemon


    


      # -    name: Start Application
      #      run: |
      #        nohup java -jar -Dspring.profiles.active=prod -Duser.timezone=Asia/Seoul /home/ubuntu/project/devoka-0.0.1-SNAPSHOT.jar &
      #        echo '서버실행 완료'
  
